#!/usr/bin/env bash

set -euo pipefail

THIS="$(realpath "$0" 2>/dev/null || command -v "$0")"
HERE="$(dirname "$THIS")"
MACHINE_TOOLS="$HERE/machine-tools"
PORTABLE_HOME="$HERE/home"

[[ -n "${LOG_NAME-}" ]] || LOG_NAME="instantiate"
. "$HERE"/log
log "gatheringâ€¦"

# --- OS and Package Manager Detection ---
OS="$(uname -s)"
PKG_MANAGER_UPDATE=""
PKG_MANAGER_INSTALL=""
PKG_MANAGER_EXT_INSTALL=""

if [[ -z "${HOME-}" ]]; then
  HOME="$(realpath ~)"
fi

if [[ -z "${HOST-}" ]]; then
  HOST="$(hostname 2>/dev/null)" || HOST=mystery-host
fi

if [[ $HOST = "mystery-host" ]]; then
  MACHINE=scoobs-van
else
  MACHINE=${HOST%%.*}
fi

export MACHINE_TOOLS PORTABLE_HOME log OS HOME HOST

# bootstrap a .env file for a new machine, or amend an existing one
machine=$(printf '%s' "$MACHINE" | tr '[:upper:]' '[:lower:]')
MACHENV="$PORTABLE_HOME/.$machine.env"
PRTBLS_LN="export PORTABLES=${HERE}"

if [[ -e "$MACHENV" ]]; then
  if ! fgrep -Eq "$PRTBLS_LN" "$MACHENV"; then
    sed -Ei '' '/^(export )?PORTABLES=/d' "$MACHENV"
    echo "$PRTBLS_LN" >>"$MACHENV"
  fi
else
  echo "$PRTBLS_LN" >"$MACHENV"
fi

. "$MACHENV"

case "$OS" in
Darwin)
  log .gather "detected macOS"
  xcode-select -p >/dev/null 2>&1 || xcode-select --install
  if [[ -n "$(bash ./machine-tools/homebrew.sh install)" ]]; then
    bash ./machine-tools/homebrew.sh self-install
  fi
  export PATH="${PATH}:/opt/homebrew/bin"
  SYS_PKG_MANAGER="homebrew"
  PKG_MANAGER_UPDATE="brew update"
  PKG_MANAGER_INSTALL="brew install"
  PKG_MANAGER_EXT_INSTALL="brew tap"
  export HOMEBREW_NO_ENV_HINTS=1
  ;;
Linux)
  log .gather "detected Linux"
  if [[ -f /etc/os-release ]]; then
    . /etc/os-release
    export ID VERSION_ID
    case "$ID" in
    ubuntu | debian | pop)
      log .gather .linux "detected Debian-based distribution ($PRETTY_NAME)"
      SYS_PKG_MANAGER="apt"
      PKG_MANAGER_UPDATE="sudo apt-get update"
      PKG_MANAGER_INSTALL="sudo apt-get install -y"
      ;;
    arch)
      log .gather .linux "detected Arch Linux"
      SYS_PKG_MANAGER="pacman"
      PKG_MANAGER_UPDATE="sudo pacman -Syu"
      PKG_MANAGER_INSTALL="sudo pacman -S --noconfirm"
      ;;
    fedora)
      log .gather .linux "detected Fedora"
      SYS_PKG_MANAGER="dnf"
      PKG_MANAGER_UPDATE="sudo dnf check-update"
      PKG_MANAGER_INSTALL="sudo dnf install -y"
      ;;
    *)
      log -e .gather .linux "unsupported Linux distribution: $ID"
      exit 1
      ;;
    esac
  else
    log -e .gather .linux "cannot determine Linux distribution; /etc/os-release not found"
    exit 1
  fi
  ;;
*)
  log -e .gather "unsupported operating system: $OS"
  exit 1
  ;;
esac

# --- 1. Collection Phase ---
log .gather "collecting package dependencies from machine-toolsâ€¦"

self_install_scripts=""
syspkgmgr_install_cmds=""
uv_install_cmds=""
pip_install_cmds=""
pipx_install_cmds=""
nvm_install_cmds=""
npm_install_cmds=""

syspkgmgr_tool_scripts=""
uv_tool_scripts=""
pip_tool_scripts=""
pipx_tool_scripts=""
nvm_tool_scripts=""
npm_tool_scripts=""

for tool_script in "$MACHINE_TOOLS"/*.sh; do
  install_cmds="$(sh "$tool_script" install)"
  for install_cmd in $install_cmds; do
    case "$install_cmd" in
    "") continue ;;
    self-install)
      self_install_scripts="${self_install_scripts:+$self_install_scripts$'\n'}$tool_script"
      ;;
    syspkgmgr:*)
      syspkgmgr_install_cmds="${syspkgmgr_install_cmds:+$syspkgmgr_install_cmds }${install_cmd#syspkgmgr:}"
      syspkgmgr_tool_scripts="${syspkgmgr_tool_scripts:+$syspkgmgr_tool_scripts$'\n'}$tool_script"
      ;;
    uv:*)
      uv_install_cmds="${uv_install_cmds:+$uv_install_cmds }${install_cmd#uv:}"
      uv_tool_scripts="${uv_tool_scripts:+$uv_tool_scripts$'\n'}$tool_script"
      ;;
    pip:*)
      pip_install_cmds="${pip_install_cmds:+$pip_install_cmds }${install_cmd#pip:}"
      pip_tool_scripts="${pip_tool_scripts:+$pip_tool_scripts$'\n'}$tool_script"
      ;;
    pipx:*)
      pipx_install_cmds="${pipx_install_cmds:+$pipx_install_cmds }${install_cmd#pipx:}"
      pipx_tool_scripts="${pipx_tool_scripts:+$pipx_tool_scripts$'\n'}$tool_script"
      ;;
    nvm:*)
      nvm_install_cmds="${nvm_install_cmds:+$nvm_install_cmds }${install_cmd#nvm:}"
      nvm_tool_scripts="${nvm_tool_scripts:+$nvm_tool_scripts$'\n'}$tool_script"
      ;;
    npm:*)
      npm_install_cmds="${npm_install_cmds:+$npm_install_cmds }${install_cmd#npm:}"
      npm_tool_scripts="${npm_tool_scripts:+$npm_tool_scripts$'\n'}$tool_script"
      ;;
    *) log -w .gather "install command not recognised: $install_cmd" ;;
    esac
  done
done

# Prime the sudo timestamp
if [[ -n "$syspkgmgr_install_cmds" ]] &&
  echo "$PKG_MANAGER_INSTALL" | grep -q "sudo"; then
  log -i "$SYS_PKG_MANAGER may need sudo accessâ€¦"
  sudo -v
fi

# --- 2. Execution Phase ---

if [[ -n "$self_install_scripts" ]]; then
  while IFS= read -r tool_script; do
    bash "$tool_script" self-install
    bash "$tool_script" config
  done <<<"$self_install_scripts"
fi

if [[ -n "$uv_install_cmds" ]] &&
  ! command -v uv >/dev/null 2>&1 &&
  [[ ! " $syspkgmgr_install_cmds " = *" uv "* ]]; then
  if [[ "$OS" = Darwin ]]; then
    syspkgmgr_install_cmds="${syspkgmgr_install_cmds:+$syspkgmgr_install_cmds }uv"
  else
    ensure_uv_installed=1
  fi
fi

if [[ -n "$pipx_install_cmds" ]] && [[ ! " $syspkgmgr_install_cmds " = *" pipx "* ]]; then
  syspkgmgr_install_cmds="${syspkgmgr_install_cmds:+$syspkgmgr_install_cmds }pipx"
fi

if [[ -n "$syspkgmgr_install_cmds" ]]; then
  core_tools=""
  ext_tools=""
  for item in $syspkgmgr_install_cmds; do
    case $item in
    *:*) ext_tools="${ext_tools:+$ext_tools }${item#*:}" ;;
    *) core_tools="${core_tools:+$core_tools }$item" ;;
    esac
  done

  log ."$SYS_PKG_MANAGER" "updating $SYS_PKG_MANAGERâ€¦"
  bash -c "$PKG_MANAGER_UPDATE"

  if [[ -n "$core_tools" ]]; then
    log ."$SYS_PKG_MANAGER" "installing system packages: $core_tools"
    bash -c "$PKG_MANAGER_INSTALL $core_tools"
  fi

  if [[ -n "$ext_tools" ]]; then
    log ."$SYS_PKG_MANAGER" "tapping external repositories: $ext_tools"
    for ext_tool in $ext_tools; do
      bash -c "$PKG_MANAGER_EXT_INSTALL $ext_tool"
    done
  fi

  log ."$SYS_PKG_MANAGER" "running system package configurationsâ€¦"
  while IFS= read -r tool_script; do
    [[ -n "$tool_script" ]] && bash "$tool_script" config
  done <<<"$syspkgmgr_tool_scripts"
fi

if [[ "${ensure_uv_installed:-0}" -gt 0 ]] && ! command -v uv >/dev/null 2>&1; then
  log .gather "installing uvâ€¦"
  curl -LsSf https://astral.sh/uv/install.sh | sh
fi

if [[ -n "$uv_install_cmds" ]]; then

  [[ "$(command -v uv 2>/dev/null)" = *homebrew* ]] || uv self update

  tools=""
  pythons=""
  for item in $uv_install_cmds; do
    case $item in
    python:*) pythons="${pythons:+$pythons }${item#*:}" ;;
    *) tools="${tools:+$tools }${item#*:}" ;;
    esac
  done

  if [[ -n "$tools" ]]; then
    tools=$(printf "%s\n" $tools | sort -u | xargs)
    log .uv "installing uv tools: $tools"
    for tool in $tools; do
      uv tool install ${tool//:/ }
    done
  fi

  if [[ -n "$pythons" ]]; then
    pythons=$(printf "%s\n" $pythons | sort -u | xargs)
    log .uv "installing uv python(s): $pythons"
    for python in $pythons; do
      uv python install ${python//:/ }
    done
  fi

  log .uv "running uv package configurationsâ€¦"
  while IFS= read -r tool_script; do
    [[ -n "$tool_script" ]] && bash "$tool_script" config
  done <<<"$uv_tool_scripts"
fi

if [[ -n "$pip_install_cmds" ]]; then
  install_list=$(printf "%s\n" $pip_install_cmds | sort -u | xargs)
  log .pip "installing user-local pip packages: $install_list"
  python3 -m pip install -U pip
  python3 -m pip install --user $install_list
  log .pip "running pip package configurationsâ€¦"
  while IFS= read -r tool_script; do
    [[ -n "$tool_script" ]] && bash "$tool_script" config
  done <<<"$pip_tool_scripts"
fi

if [[ -n "$pipx_install_cmds" ]]; then
  install_list=$(printf "%s\n" $pipx_install_cmds | sort -u | xargs)
  log .pipx "installing user-local pipx packages: $install_list"
  pipx install $install_list
  log .pipx "running pipx package configurationsâ€¦"
  while IFS= read -r tool_script; do
    [[ -n "$tool_script" ]] && bash "$tool_script" config
  done <<<"$pipx_tool_scripts"
fi

if [[ -n "$nvm_install_cmds" ]]; then
  install_list=$(printf "%s\n" $nvm_install_cmds | sort -u | xargs)
  log .nvm "installing node versions with nvm: $install_list"
  export NVM_DIR="$HOME/.nvm"
  [[ -s "$NVM_DIR/nvm.sh" ]] && . "$NVM_DIR/nvm.sh"
  nvm install "$install_list"
  log .nvm "checking for node configurationsâ€¦"
  while IFS= read -r tool_script; do
    [[ -n "$tool_script" ]] && bash "$tool_script" config
  done <<<"$nvm_tool_scripts"
fi

if [[ -n "$npm_install_cmds" ]]; then
  install_list=$(printf "%s\n" $npm_install_cmds | sort -u | xargs)
  log .npm "installing global npm packages: $install_list"
  export NVM_DIR="$HOME/.nvm"
  [[ -s "$NVM_DIR/nvm.sh" ]] && . "$NVM_DIR/nvm.sh"
  npm install -g $install_list
  log .npm "running npm package configurationsâ€¦"
  while IFS= read -r tool_script; do
    [[ -n "$tool_script" ]] && bash "$tool_script" config
  done <<<"$npm_tool_scripts"
fi

log -i "portables instantiated. GLHFDD ðŸŽ"
